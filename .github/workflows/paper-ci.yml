name: Build and Paper Server Smoke Test

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Build plugin and run unit tests
        run: mvn -B -ntp clean verify

      - name: Prepare Paper server directory
        run: |
          mkdir -p server/plugins
          cp target/mcexp-hideandseek-*.jar server/plugins/
          cd server
          echo "eula=true" > eula.txt

      - name: Download Paper 1.21.8
        working-directory: server
        run: |
          PAPER_VERSION=1.21.8
          PAPER_BUILD=149
          PAPER_JAR="paper-${PAPER_VERSION}-${PAPER_BUILD}.jar"
          curl -L \
            "https://api.papermc.io/v2/projects/paper/versions/${PAPER_VERSION}/builds/${PAPER_BUILD}/downloads/${PAPER_JAR}" \
            -o "${PAPER_JAR}"

      - name: Start Paper server with plugin (smoke test)
        working-directory: server
        run: |
          PAPER_JAR=$(ls paper-*.jar)
          # Run server for up to 90 seconds to allow startup
          timeout 90 java -Xms512M -Xmx1G -jar "$PAPER_JAR" --nogui || true

      - name: Verify plugin loaded successfully
        working-directory: server
        run: |
          if [ ! -f logs/latest.log ]; then
            echo "latest.log not found; server may not have started correctly"
            exit 1
          fi
          if ! grep -q "Enabling KenshinsHideAndSeek v" logs/latest.log; then
            echo "Plugin did not appear to enable successfully in server log"
            grep -n "KenshinsHideAndSeek" logs/latest.log || true
            exit 1
          fi
          echo "Plugin enabled successfully on a real Paper server."

