name: Build and Paper Server Smoke Test

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build plugin and run unit tests
        run: mvn -B -ntp clean verify

      - name: Prepare Paper server directory
        run: |
          mkdir -p server/plugins/KenshinsHideAndSeek
          cp target/mcexp-hideandseek-*.jar server/plugins/
          cp ci/server-config/server.properties server/
          cp ci/server-config/maps.yml server/plugins/KenshinsHideAndSeek/
          cp ci/server-config/config.yml server/plugins/KenshinsHideAndSeek/
          cd server
          echo "eula=true" > eula.txt

      - name: Download ProtocolLib
        working-directory: server/plugins
        run: |
          curl -L \
            "https://github.com/dmulloy2/ProtocolLib/releases/download/5.4.0/ProtocolLib.jar" \
            -o ProtocolLib.jar

      - name: Download Paper 1.21.4
        working-directory: server
        run: |
          PAPER_VERSION=1.21.4
          PAPER_BUILD=232
          PAPER_JAR="paper-${PAPER_VERSION}-${PAPER_BUILD}.jar"
          curl -L \
            "https://api.papermc.io/v2/projects/paper/versions/${PAPER_VERSION}/builds/${PAPER_BUILD}/downloads/${PAPER_JAR}" \
            -o "${PAPER_JAR}"

      - name: Start Paper server
        working-directory: server
        run: |
          PAPER_JAR=$(ls paper-*.jar)
          java -Xms512M -Xmx1G -jar "$PAPER_JAR" --nogui > server.log 2>&1 &
          echo $! > ../server.pid
          # Wait for server to finish starting (up to ~120s)
          timeout=120
          while [ $timeout -gt 0 ]; do
            if grep -q "Done (" server.log 2>/dev/null; then
              echo "Server started."
              break
            fi
            sleep 5
            timeout=$((timeout-5))
          done
          if [ $timeout -le 0 ]; then
            echo "Server did not start in time"
            cat server.log
            exit 1
          fi

      - name: Install bot dependencies
        working-directory: ci/bots
        run: npm install

      - name: Run JavaScript bot smoke test
        working-directory: ci/bots
        run: node ci-bot-test.js

      - name: Stop Paper server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill "$(cat server.pid)" || true
            sleep 5
          fi

      - name: Print server warnings, errors, and disguise logs
        working-directory: server
        run: |
          echo "---- server.log (WARN/ERROR/Exception lines) ----"
          if [ -f server.log ]; then
            (grep -En 'WARN|ERROR|Exception' server.log || echo 'No WARN/ERROR/Exception lines in server.log')
          else
            echo "server.log not found"
          fi
          echo "---- logs/latest.log (WARN/ERROR/Exception lines) ----"
          if [ -f logs/latest.log ]; then
            (grep -En 'WARN|ERROR|Exception' logs/latest.log || echo 'No WARN/ERROR/Exception lines in latest.log')
          else
            echo "logs/latest.log not found"
          fi
          echo "---- logs/latest.log ([DISGUISE] lines) ----"
          if [ -f logs/latest.log ]; then
            if grep -En '\\[DISGUISE\\]' logs/latest.log; then
              echo \"[CI] Found disguise debug logs.\"
            else
              echo \"[CI] No [DISGUISE] logs found; disguise may not have spawned or updated.\"
              exit 1
            fi
          fi

      - name: Verify plugin loaded successfully
        working-directory: server
        run: |
          if [ ! -f logs/latest.log ]; then
            echo "latest.log not found; server may not have started correctly"
            exit 1
          fi
          if ! grep -q "Enabling KenshinsHideAndSeek v" logs/latest.log; then
            echo "Plugin did not appear to enable successfully in server log"
            grep -n "KenshinsHideAndSeek" logs/latest.log || true
            exit 1
          fi
          echo "Plugin enabled successfully on a real Paper server."
